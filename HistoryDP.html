<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="stylesheet" href="chatbot.css">

  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Clinic History</title>
  <link rel="stylesheet" href="DentalProject.css">
  <style>
    /* Modal Styles */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
    }
    .modal-content {
      background-color: #fefefe;
      margin: 5% auto;
      padding: 30px;
      border-radius: 15px;
      width: 90%;
      max-width: 600px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
      max-height: 90vh;
      overflow-y: auto;
    }
    .close {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
    }
    .close:hover {
      color: #000;
    }
    #editForm {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    #editForm label {
      display: block;
      font-weight: 600;
      font-weight: bold;
    }
    #editForm input,
    #editForm select {
      width: 100%;
      padding: 11px;
      border-radius: 12px;
      border: 1px solid rgba(16,32,40,0.15);
      font-size: 0.95rem;
    }
    #editForm button {
      padding: 12px 20px;
      border-radius: 14px;
      border: none;
      cursor: pointer;
    }
    .modal-actions {
      display: flex;
      justify-content: flex-end;
      gap: 12px;
      margin-top: 20px;
    }
    .modal-save-btn {
      background: linear-gradient(135deg, #1cbbb4, #3dc5f3);
      color: white;
      font-weight: 600;
    }
    .modal-cancel-btn {
      background: #e5e7eb;
      color: #0f4c5c;
      font-weight: 600;
    }
    .btn-edit {
      background: #2ec4b6;
      color: white;
    }
    .btn-delete {
      background: #ef4444;
      color: white;
    }
    .btn-save {
      background: #10b981;
      color: white;
    }
    .btn-cancel {
      background: #6b7280;
      color: white;
    }
    .action-buttons {
      display: flex;
      gap: 10px;
    }
    .action-buttons button {
      padding: 5px 15px;
      font-size: 14px;
    }
    /* History Layout */
    .history-header {
      text-align: center;
      padding: 40px 20px 10px;
    }
    .history-header h1 {
      margin: 0 0 10px;
      color: #0f4c5c;
    }
    .history-header p {
      margin: 0 auto;
      color: #5b7281;
      max-width: 520px;
    }
    .history-wrapper {
      max-width: 960px;
      margin: 0 auto 60px;
      padding: 0 20px;
    }
    .history-login-card,
    .history-results {
      background: #ffffff;
      border-radius: 24px;
      padding: 24px;
      box-shadow: 0 20px 40px rgba(15, 74, 84, 0.08);
      border: 1px solid rgba(15, 74, 84, 0.06);
      margin-bottom: 24px;
    }
    .history-login-card h2 {
      margin-top: 0;
      color: #0f4c5c;
    }
    .history-login-card input {
      width: 100%;
      padding: 12px;
      margin: 8px 0;
      border-radius: 12px;
      border: 1px solid rgba(16, 32, 40, 0.15);
      font-size: 1rem;
    }
    .history-btn {
      width: 100%;
      margin-top: 12px;
    }
    .history-info-note {
      font-size: 0.95rem;
      color: #5b7281;
      margin-top: 12px;
    }
    .history-results {
      display: none;
    }
    .history-results.active {
      display: block;
    }
    .hidden {
      display: none !important;
    }
    .history-results-head {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 12px;
    }
    .history-table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0 8px;
      margin-top: 16px;
    }
    .history-table th {
      text-align: left;
      font-size: 0.85rem;
      color: #0f4c5c;
      padding-bottom: 4px;
      text-transform: uppercase;
    }
    .history-table td {
      background: #f9feff;
      padding: 12px;
      border-radius: 12px;
      box-shadow: inset 0 0 0 1px rgba(28, 187, 180, 0.08);
    }
    .history-table tr:hover td {
      background: #eefcff;
    }
    .logout-btn {
      background: #ff6b6b;
      color: white;
      border: none;
      border-radius: 10px;
      padding: 8px 18px;
      cursor: pointer;
    }
  </style>
</head>
<body>

<nav class="navbar">
  <div class="logo">SMILE CLINIC </div>
  <ul class="nav-links">
    <li><a href="index.html">Home </a></li>
    <li><a href="DoctorsDP.html">Our Doctors </a></li>
    <li><a href="ServiceDP.html">Our Services </a></li>
    <li><a href="EmergencyDP.html" class="emergency-btn">Emergency </a></li>
    <li><a href="BookingDP.html">Book Now </a></li>
    <li><a href="HistoryDP.html">Patient History </a></li>
  </ul>
</nav>

<section class="history-header">
  <h1>Your Patient Profile</h1>
  <p>Log in to review, update, or cancel upcoming visits. We keep your treatment history secure and accessible.</p>
</section>

<div class="history-wrapper">
  <div class="history-login-card">
    <h2>Login to Continue</h2>
    <input type="text" id="username" placeholder="Enter Username">
    <input type="password" id="password" placeholder="Enter Password">
    <button class="history-btn" onclick="login()">View My History</button>
    <p id="error-msg"></p>
    <p class="history-info-note">Forgot your password? Contact the clinic and weâ€™ll reset it instantly.</p>
  </div>

  <div id="history-section" class="history-results">
    <div class="history-results-head">
      <div>
        <h2>Your Appointments</h2>
        <p class="timeline-hint">Appointments booked with this account appear below.</p>
      </div>
      <button class="logout-btn" type="button" onclick="logout()">Log Out</button>
    </div>
    <table class="history-table">
      <tr>
        <th>Date</th>
        <th>Doctor</th>
        <th>Service</th>
        <th>Status</th>
        <th>Actions</th>
      </tr>
    </table>
  </div>

  <!-- Edit Appointment Modal -->
  <div id="editModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeEditModal()">&times;</span>
      <h2>Edit Appointment</h2>
      <form id="editForm">
        <label for="editDate">Date:</label>
        <input type="date" id="editDate" required>

        <label for="editTime">Time:</label>
        <select id="editTime" required>
          <option value="">Select Time</option>
        </select>

        <label for="editDoctor">Doctor:</label>
        <select id="editDoctor" required>
          <option value="">Select Doctor</option>
        </select>

        <label for="editService">Service:</label>
        <select id="editService">
          <option value="">Select Service (Optional)</option>
        </select>

        <label for="editStatus">Status:</label>
        <select id="editStatus">
          <option value="pending">Pending</option>
          <option value="confirmed">Confirmed</option>
          <option value="completed">Completed</option>
          <option value="cancelled">Cancelled</option>
        </select>

        <label for="editNotes">Notes:</label>
        <input type="text" id="editNotes" placeholder="Optional notes">

        <div class="modal-actions">
          <button type="button" class="modal-cancel-btn" onclick="closeEditModal()">Cancel</button>
          <button type="submit" class="modal-save-btn">Save Changes</button>
        </div>
      </form>
    </div>
  </div>

</div>


<script>
const API_URL = (function resolveApiBase() {
  if (window.API_BASE_URL) {
    return window.API_BASE_URL.replace(/\/$/, '');
  }
  const { protocol, hostname, port, origin } = window.location;
  const isLocalhost = hostname === 'localhost' || hostname === '127.0.0.1';
  if (protocol === 'file:' || !hostname) {
    return 'http://localhost:3000/api';
  }
  if (isLocalhost) {
    const resolvedPort = port || '3000';
    return `${protocol}//${hostname}:${resolvedPort}/api`;
  }
  return `${origin.replace(/\/$/, '')}/api`;
})();
let currentToken = null;
let currentUserId = null;
let doctorsData = [];
let servicesData = [];
let currentAppointmentId = null;

const loginBox = document.querySelector('.history-login-card');
const historySection = document.getElementById('history-section');

window.addEventListener('DOMContentLoaded', function() {
  loadDoctorsAndServices();
  const storedToken = localStorage.getItem('authToken');
  const storedUserId = localStorage.getItem('userId');
  if (storedToken && storedUserId) {
    currentToken = storedToken;
    currentUserId = storedUserId;
    loadPatientHistory(storedToken, storedUserId);
  }
});

async function login() {
  const username = document.getElementById("username").value;
  const password = document.getElementById("password").value;
  const error = document.getElementById("error-msg");

  if (username === "" || password === "") {
    error.innerHTML = "Please enter both fields.";
    return;
  }

  // Try login with username as email (or use username@smileclinic.com)
  const email = username.includes('@') ? username : username + '@smileclinic.com';

  try {
    const response = await fetch(`${API_URL}/auth/login`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email: email, password: password })
    });

    const result = await response.json();

    if (result.success && result.data.token) {
      // Save token
      currentToken = result.data.token;
      currentUserId = result.data.user.id;
      localStorage.setItem('authToken', currentToken);
      localStorage.setItem('userId', currentUserId);
      localStorage.removeItem('userName');
      
      // Hide login box and show history
      loginBox.classList.add("hidden");
      historySection.classList.add("active");
      
      // Load patient history
      loadPatientHistory(currentToken, currentUserId);
    } else {
      error.innerHTML = result.message || "Incorrect username or password.";
    }
  } catch (error) {
    console.error('Login error:', error);
    document.getElementById("error-msg").innerHTML = "Error connecting to server. Please try again.";
  }
}

async function loadPatientHistory(token, userId = null) {
  if (!userId) {
    // Get current user first
    try {
      const userResponse = await fetch(`${API_URL}/auth/me`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      const userData = await userResponse.json();
      if (userData.success) {
        userId = userData.data.user.id;
        localStorage.setItem('userId', userId);
        localStorage.removeItem('userName');
      }
    } catch (error) {
      console.error('Error getting user:', error);
      return;
    }
  }

  if (!userId) {
    document.getElementById("error-msg").innerHTML = "Could not load user information.";
    return;
  }

  try {
    const response = await fetch(`${API_URL}/users/${userId}/appointments`, {
      headers: { 'Authorization': `Bearer ${token}` }
    });

    const result = await response.json();

    if (result.success) {
      displayAppointments(result.data.appointments);
      
      // Show history section
      loginBox.classList.add("hidden");
      historySection.classList.add("active");
    } else {
      document.getElementById("error-msg").innerHTML = result.message || "Error loading history.";
    }
  } catch (error) {
    console.error('Error loading history:', error);
    document.getElementById("error-msg").innerHTML = "Error loading appointment history.";
  }
}

function displayAppointments(appointments) {
  const table = document.querySelector('.history-table');
  
  // Clear existing rows (except header)
  const headerRow = table.querySelector('tr');
  table.innerHTML = '';
  table.appendChild(headerRow);

  if (appointments.length === 0) {
    const row = table.insertRow();
    const cell = row.insertCell();
    cell.colSpan = 5;
    cell.textContent = 'No appointments found.';
    cell.style.textAlign = 'center';
    cell.style.padding = '20px';
    return;
  }

  appointments.forEach(appointment => {
    const row = table.insertRow();
    
    // Format date
    const date = new Date(appointment.date);
    const dateStr = date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
    
    // Format time
    const timeStr = appointment.time || '';
    
    // Get doctor name and ID
    let doctorName = 'N/A';
    let doctorId = null;
    if (appointment.doctor) {
      if (typeof appointment.doctor === 'object') {
        doctorName = appointment.doctor.name;
        doctorId = appointment.doctor._id || appointment.doctor.id;
      } else {
        doctorName = appointment.doctor;
      }
    }
    
    // Get service name
    let serviceName = 'General';
    if (appointment.service) {
      if (typeof appointment.service === 'object' && appointment.service.name) {
        serviceName = appointment.service.name;
      } else if (typeof appointment.service === 'string') {
        serviceName = 'Service';
      }
    }
    
    // Get status
    const status = appointment.status || 'pending';
    const statusColors = {
      'pending': '#f59e0b',
      'confirmed': '#10b981',
      'completed': '#6366f1',
      'cancelled': '#ef4444'
    };
    
    // Date cell
    row.insertCell().textContent = dateStr + (timeStr ? ` at ${timeStr}` : '');
    
    // Doctor cell
    row.insertCell().textContent = doctorName;
    
    // Service cell
    row.insertCell().textContent = serviceName;
    
    // Status cell
    const statusCell = row.insertCell();
    statusCell.innerHTML = `<span style="color: ${statusColors[status] || '#000'}; font-weight: bold;">${status.toUpperCase()}</span>`;
    
    // Actions cell
    const actionsCell = row.insertCell();
    const actionsDiv = document.createElement('div');
    actionsDiv.className = 'action-buttons';
    
    const editBtn = document.createElement('button');
    editBtn.className = 'btn-edit';
    editBtn.textContent = 'Edit';
    editBtn.onclick = () => openEditModal(appointment);
    
    const deleteBtn = document.createElement('button');
    deleteBtn.className = 'btn-delete';
    deleteBtn.textContent = 'Delete';
    deleteBtn.onclick = () => deleteAppointment(appointment._id);
    
    actionsDiv.appendChild(editBtn);
    actionsDiv.appendChild(deleteBtn);
    actionsCell.appendChild(actionsDiv);
  });
}

// Load doctors and services for edit form
async function loadDoctorsAndServices() {
  try {
    const [doctorsRes, servicesRes] = await Promise.all([
      fetch(`${API_URL}/doctors`),
      fetch(`${API_URL}/services`)
    ]);
    
    const doctorsResult = await doctorsRes.json();
    const servicesResult = await servicesRes.json();
    
    if (doctorsResult.success) {
      doctorsData = doctorsResult.data.doctors;
    }
    if (servicesResult.success) {
      servicesData = servicesResult.data.services;
    }
  } catch (error) {
    console.error('Error loading doctors/services:', error);
  }
}

// Open edit modal
function openEditModal(appointment) {
  currentAppointmentId = appointment._id;
  const modal = document.getElementById('editModal');
  
  // Set form values
  const date = new Date(appointment.date);
  document.getElementById('editDate').value = date.toISOString().split('T')[0];
  document.getElementById('editTime').value = appointment.time || '';
  document.getElementById('editStatus').value = appointment.status || 'pending';
  document.getElementById('editNotes').value = appointment.notes || '';
  
  // Populate doctor dropdown
  const doctorSelect = document.getElementById('editDoctor');
  doctorSelect.innerHTML = '<option value="">Select Doctor</option>';
  doctorsData.forEach(doc => {
    const option = document.createElement('option');
    option.value = doc._id;
    option.textContent = doc.name;
    if (appointment.doctor && (appointment.doctor._id === doc._id || appointment.doctor === doc._id)) {
      option.selected = true;
    }
    doctorSelect.appendChild(option);
  });
  
  // Populate service dropdown
  const serviceSelect = document.getElementById('editService');
  serviceSelect.innerHTML = '<option value="">Select Service (Optional)</option>';
  servicesData.forEach(service => {
    const option = document.createElement('option');
    option.value = service._id;
    option.textContent = service.name;
    if (appointment.service && (appointment.service._id === service._id || appointment.service === service._id)) {
      option.selected = true;
    }
    serviceSelect.appendChild(option);
  });
  
  // Update time options based on selected doctor
  updateTimeOptions(appointment.doctor ? (appointment.doctor._id || appointment.doctor) : null);
  
  doctorSelect.addEventListener('change', function() {
    updateTimeOptions(this.value);
  });
  
  modal.style.display = 'block';
}

// Update time options based on doctor
function updateTimeOptions(doctorId) {
  const timeSelect = document.getElementById('editTime');
  const currentTime = timeSelect.value;
  
  if (doctorId && doctorsData.length > 0) {
    const doctor = doctorsData.find(d => d._id === doctorId);
    if (doctor && doctor.availableTimes) {
      timeSelect.innerHTML = '<option value="">Select Time</option>';
      doctor.availableTimes.forEach(time => {
        const option = document.createElement('option');
        option.value = time;
        option.textContent = time;
        if (time === currentTime) {
          option.selected = true;
        }
        timeSelect.appendChild(option);
      });
    }
  }
}

// Close edit modal
function closeEditModal() {
  document.getElementById('editModal').style.display = 'none';
  currentAppointmentId = null;
  document.getElementById('editForm').reset();
}

// Handle edit form submission
document.getElementById('editForm').addEventListener('submit', async function(e) {
  e.preventDefault();
  
  if (!currentToken || !currentAppointmentId) {
    alert('Please login first');
    return;
  }
  
  const updateData = {
    date: document.getElementById('editDate').value,
    time: document.getElementById('editTime').value,
    doctor: document.getElementById('editDoctor').value,
    status: document.getElementById('editStatus').value,
    notes: document.getElementById('editNotes').value
  };
  
  const serviceId = document.getElementById('editService').value;
  if (serviceId) {
    updateData.service = serviceId;
  }
  
  try {
    const response = await fetch(`${API_URL}/appointments/${currentAppointmentId}`, {
      method: 'PUT',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${currentToken}`
      },
      body: JSON.stringify(updateData)
    });
    
    const result = await response.json();
    
    if (result.success) {
      alert('Appointment updated successfully!');
      closeEditModal();
      // Reload history
      loadPatientHistory(currentToken, currentUserId);
    } else {
      alert('Error: ' + (result.message || 'Failed to update appointment'));
    }
  } catch (error) {
    console.error('Update error:', error);
    alert('Error updating appointment. Please try again.');
  }
});

// Delete appointment
async function deleteAppointment(appointmentId) {
  if (!currentToken) {
    alert('Please login first');
    return;
  }
  
  if (!confirm('Are you sure you want to delete this appointment? This action cannot be undone.')) {
    return;
  }
  
  try {
    const response = await fetch(`${API_URL}/appointments/${appointmentId}`, {
      method: 'DELETE',
      headers: {
        'Authorization': `Bearer ${currentToken}`
      }
    });
    
    const result = await response.json();
    
    if (result.success) {
      alert('Appointment deleted successfully!');
      // Reload history
      loadPatientHistory(currentToken, currentUserId);
    } else {
      alert('Error: ' + (result.message || 'Failed to delete appointment'));
    }
  } catch (error) {
    console.error('Delete error:', error);
    alert('Error deleting appointment. Please try again.');
  }
}

// Close modal when clicking outside
window.onclick = function(event) {
  const modal = document.getElementById('editModal');
  if (event.target === modal) {
    closeEditModal();
  }
}

function logout(silent = false) {
  currentToken = null;
  currentUserId = null;
  localStorage.removeItem('authToken');
  localStorage.removeItem('userId');
  historySection.classList.remove("active");
  loginBox.classList.remove("hidden");
  document.getElementById("username").value = '';
  document.getElementById("password").value = '';
  if (!silent) {
    document.getElementById("error-msg").innerHTML = 'You have been logged out.';
  } else {
    document.getElementById("error-msg").innerHTML = '';
  }
  closeEditModal();
}
</script>
<script src="inject-chatbot.js"></script>
<!-- Chatbot Widget -->
<div id="chatbot-icon">ðŸ’¬</div>

<div id="chatbot-window">
    <div class="chatbot-header">Smile Dental Support</div>
    <div class="chatbot-messages"></div>
    <div class="chatbot-input">
        <input type="text" id="chatbot-text" placeholder="Type your message...">
        <button id="chatbot-send">Send</button>
    </div>
</div>

<script src="chatbot.js"></script>
<script src="inject-chatbot.js"></script>

</body>
</html>
